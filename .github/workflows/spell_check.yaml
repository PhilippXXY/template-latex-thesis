# Reusable workflow to check spelling in LaTeX files using aspell
# - Uses project-specific dictionary (aspell-project.dict)
# - Supports custom language and file patterns
# - Can optionally fail on spelling errors
name: Spell Check

on:
  workflow_call:
    inputs:
      fail_on_errors:
        description: "Fail if spelling errors are found"
        type: boolean
        default: false
      language:
        description: "Language for spell checking"
        type: string
        default: "en"
      include_patterns:
        description: "File patterns to check (comma-separated)"
        type: string
        default: "*.tex"

  workflow_dispatch:
    inputs:
      fail_on_errors:
        description: "Fail if spelling errors are found"
        type: boolean
        default: false
      language:
        description: "Language for spell checking"
        type: string
        default: "en"
      include_patterns:
        description: "File patterns to check"
        type: string
        default: "*.tex"

jobs:
  spell-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install aspell
        run: |
          sudo apt-get update
          sudo apt-get install -y aspell aspell-en

      - name: Run spell check
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Spell Check with aspell ==="
          echo ""

          LANG="${{ inputs.language }}"
          HAS_ERRORS=false
          TOTAL_ISSUES=0

          # Find all .tex files
          TEX_FILES=$(find thesis -name "*.tex" -type f)

          if [ -z "$TEX_FILES" ]; then
            echo "No .tex files found"
            exit 0
          fi

          # Check if aspell config exists
          CONF_FILE=".aspell.conf"
          CONF_ARG=""
          if [ -f "$CONF_FILE" ]; then
            CONF_ARG="--conf=./$CONF_FILE"
            echo "Using aspell config: $CONF_FILE"
          fi

          echo ""

          for file in $TEX_FILES; do
            echo "Checking: $file"

            # Get misspelled words
            MISSPELLED=$(cat "$file" | aspell --mode=tex --lang="$LANG" $CONF_ARG list 2>/dev/null | sort -u || true)

            if [ -n "$MISSPELLED" ]; then
              COUNT=$(echo "$MISSPELLED" | wc -l | tr -d ' ')
              TOTAL_ISSUES=$((TOTAL_ISSUES + COUNT))
              HAS_ERRORS=true

              echo "  Found $COUNT potential misspelling(s):"
              echo "$MISSPELLED" | head -15 | sed 's/^/    - /'

              if [ "$COUNT" -gt 15 ]; then
                echo "    ... and $((COUNT - 15)) more"
              fi

              # GitHub annotations
              while IFS= read -r word; do
                LINE=$(grep -n -m1 "\b${word}\b" "$file" 2>/dev/null | head -1 | cut -d: -f1 || echo "1")
                echo "::warning file=$file,line=$LINE::Potential misspelling: $word"
              done <<< "$(echo "$MISSPELLED" | head -5)"
            else
              echo "  No issues found"
            fi

            echo ""
          done

          echo "=== Summary ==="
          echo "Total potential misspellings: $TOTAL_ISSUES"
          echo ""

          if [ "$HAS_ERRORS" = "true" ]; then
            echo "Add valid words to aspell-project.dict to suppress false positives"

            if [ "${{ inputs.fail_on_errors }}" = "true" ]; then
              echo ""
              echo "::error::Found $TOTAL_ISSUES spelling issue(s)"
              exit 1
            fi
          else
            echo "No spelling issues found"
          fi
