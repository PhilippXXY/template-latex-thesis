# This workflow automatically manages GitHub issue status labels based on branch creation and issue closure events.
name: Manage Issue Status Labels

# Grant permissions to the workflow to modify issues
permissions:
  issues: write

# Define the events that trigger this workflow
on:
  # The 'create' event triggers when a branch or tag is created.
  # Here, we use a null value because no extra configuration is needed.
  create: null
  # The 'issues' event with type 'closed' triggers when an issue is closed.
  issues:
    types: [closed]

jobs:
  # Job to handle branch creation events and update issue status labels accordingly
  branch_label:
    # Run this job only when a branch is created
    if: github.event_name == 'create' && github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      # Extract the issue number from the branch name
      - name: Extract issue number from branch name
        id: extract
        shell: bash
        run: |
          # Remove "refs/heads/" prefix to obtain the branch name
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch name: $BRANCH_NAME"
          # Expect the branch name to start with an issue number (e.g., "123-add-feature")
          if [[ "$BRANCH_NAME" =~ ^([0-9]+)[-_.] ]]; then
            ISSUE_NUMBER=${BASH_REMATCH[1]}
            echo "Issue number detected: $ISSUE_NUMBER"
            # Output the detected issue number for later steps
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "No issue number found in branch name. Skipping."
            exit 0
          fi

      # Remove any existing status labels and add "status - In Progress"
      - name: Remove any status labels and add "status - In Progress"
        uses: actions/github-script@v8
        env:
          ISSUE_NUMBER: ${{ steps.extract.outputs.issue_number }}
        with:
          script: |
            // Parse the issue number from the environment variable
            const issueNumber = parseInt(process.env.ISSUE_NUMBER, 10);
            if (!issueNumber) {
              console.log("No issue number provided, exiting.");
              return;
            }

            // Retrieve the current labels on the issue
            const { data: existingLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            // Iterate over the labels and remove any that start with "status -"
            for (const label of existingLabels) {
              if (label.name.toLowerCase().startsWith('status -')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: label.name,
                }).catch(err => {
                  console.log(`Could not remove ${label.name}: ${err.message}`);
                });
              }
            }

            // Add the new status label "status - In Progress" to the issue
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['status - In Progress'],
            });

  # Job to handle issue closure events and update status labels based on the close reason
  issue_closed:
    # Run this job only when an issue is closed
    if: github.event_name == 'issues' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Remove status labels and set correct status on close
        uses: actions/github-script@v8
        with:
          script: |
            // Get the issue details from the event payload
            const issue = context.payload.issue;
            const issueNumber = issue.number;

            // Retrieve the current labels on the issue
            const { data: existingLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });
            // Remove all labels that start with "status -"
            for (const label of existingLabels) {
              if (label.name.toLowerCase().startsWith('status -')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: label.name,
                }).catch(err => {
                  console.log(`Could not remove ${label.name}: ${err.message}`);
                });
              }
            }

            // Determine the new label based on the issue's close reason
            // If the close reason is 'not_planned', set the status to "status - Blocked"; otherwise, use "status - Completed"
            const newLabel = issue.state_reason === 'not_planned'
              ? 'status - Blocked'
              : 'status - Completed';

            // Add the new status label to the issue
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: [newLabel],
            });
